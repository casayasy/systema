<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inicio de Sesión</title>
  <link rel="icon" href="img/yasy.jpeg">
  <link rel="stylesheet" href="css/styles.css">

  <link rel="stylesheet" href="dt/datatables.min.css">

  <link rel="stylesheet" href="bt-icons/bootstrap-icons.min.css">
  <link rel="stylesheet" href="bt/bootstrap.min.css">
  <script src="bt/bootstrap.min.js"></script>

  <link rel="stylesheet" href="alert/alertify.min.css">
  <link rel="stylesheet" href="alert/themes/default.min.css">
  <script src="alert/alertify.min.js"></script>
</head>
<body class="bg-body-secondary">
  <div class="loader">
    <h1 id="greeting">Bienvenido a Casa Yasy S.A</h1>
  </div>

  <div class="body2">
    <div class="card col-md-6 border-primary  mx-auto mt-5">
      <div class="form-container login-form">
        <h2>Iniciar Sesión</h2>
        <p align="center"class="sombra" ><img src="img/ORIG-LOGO-CASA-YASY-50-años-PNG.png"
           width="200px" alt="Giro infinito" class="giro-infinito"></p>
      </div>
  
      <div class="card-body">
        <form class="row g-3 needs-validation mt-2" id="login" novalidate>
          <div class="input-group col-md-6">
            <span class="input-group-text"><i class="bi bi-person-square"></i></span>
            <input type="text" class="form-control" id="usuario" placeholder="Usuario" value="" required>
            <div class="invalid-feedback">
                !Ingrese el usuario!
            </div>
          </div>
          <div class="input-group col-md-6">
            <span class="input-group-text"><i class="bi bi-key-fill"></i></i></span>
            <input type="password" class="form-control" id="contrasena" placeholder="Contraseña" value="" required>
            <div class="invalid-feedback">
                !Ingrese la contraseña!
            </div>
          </div>
          <div class="col-12">
            <div class="col-6 d-grid mx-auto">
              <button class="btn btn-success" type="submit"><i class="bi bi-unlock-fill"></i> Ingresar</button>
            </div>
          </div>
        </form>
      </div>
  
      <div class="card-footer">
        <label id="mensaje"></label>
      </div>
  </div>

  <div class="text-center mt-5">
    <button class="btn btn-success btn-sm" title="Ver la base de datos" data-bs-toggle="modal" data-bs-target="#verBD" onclick="verBD()"><i class="bi bi-eye"></i></button>
    <button class="btn btn-primary btn-sm" title="Cargar la base de datos" onclick="cargarBD()"><i class="bi bi-database-add"></i></button>
    <button class="btn btn-warning btn-sm" title="Vaciar la base de datos" onclick="vaciarBD()"><i class="bi bi-trash"></i></button>
  </div>


<!-- Ver la Base de datos -->
  <div class="modal fade" id="verBD" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalCenteredScrollableTitle">Ver la Base de Datos</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="h6">Los datos que se visualizan se encuentran en el localStorage</p>
          <!-- USUARIOS -->
          <p class="fw-bold text-primary">USUARIOS</p>
          <table id="tabla_usuarios" class="display compact" style="width:100%">
            <thead>
              <tr>
                <th>Id Usuario</th>
                <th>N° Cédula</th>
                <th>Nombre</th>
                <th>Celular</th>
                <th>Usuario</th>
                <th>Contraseña</th>
                <th>Cargo</th>
              </tr>
            </thead>
          </table>

          <!-- PROVEEDORES -->
          <p class="fw-bold text-primary">PROVEEDORES</p>
          <table id="tabla_proveedores" class="display compact" style="width:100%">
            <thead>
              <tr>
                <th>Id Proveedor</th>
                <th>RUC</th>
                <th>Razón Social</th>
                <th>Dirección</th>
                <th>Teléfono</th>
                <th>Ciudad</th>
              </tr>
            </thead>
          </table>

            <!-- MARCAS -->
            <p class="fw-bold text-primary">MARCAS</p>
            <table id="tabla_marcas" class="display compact" style="width:100%">
              <thead>
                <tr>
                  <th>Id Marca</th>
                  <th>Marca</th>
                </tr>
              </thead>
            </table>

            <!-- CLASIFICACIONES -->
            <p class="fw-bold text-primary">FAMILIAS</p>
            <table id="tabla_clasificaciones" class="display compact" style="width:100%">
              <thead>
                <tr>
                  <th>Id Clasificación</th>
                  <th>Clasificación</th>
                </tr>
              </thead>
            </table>

            <!-- ARTICULOS -->
            <p class="fw-bold text-primary">ARTÍCULOS</p>
            <table id="tabla_articulos" class="display compact" style="width:100%">
              <thead>
                <tr>
                  <th>Id Artículo</th>
                  <th>Código de Barras</th>
                  <th>Descripción</th>
                  <th>Marca</th>
                  <th>Clasificación</th>
                  <th>I.V.A.</th>
                  <th>Stock Actual</th>
                  <th>Precio Venta</th>
                </tr>
              </thead>
            </table>

            <!-- COMPRAS -->
            <p class="fw-bold text-primary">COMPRAS</p>
            <table id="tabla_comprascabecera" class="display compact" style="width:100%">
              <thead>
                <tr>
                  <th>Id Compra</th>
                  <th>Proveedor</th>
                  <th>N° Factura</th>
                  <th>Fec. Compra</th>
                  <th>Condición</th>
                  <th>Sub. Exenta</th>
                  <th>Sub. I.V.A. 5%</th>
                  <th>Sub. I.V.A. 10%</th>
                  <th>Total</th>
                  <th>Liq. I.V.A. 5%</th>
                  <th>Liq. I.V.A. 10%</th>
                  <th>Tot. I.V.A.</th>
                  <th>Saldo</th>
                  <th>Anulado</th>
                  <th>Detalle</th>
                </tr>
              </thead>
            </table>
          

            <p class="fw-bold text-primary">VENTAS</p>
          <table id="tabla_ventas" class="display compact" style="width:100%">
            <thead>
              <tr>
                <th>Factura</th>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Total</th>
                <th>IVA</th>
                <th>Condición</th>
                <th>Estado</th>
                <th>Detalle</th>
              </tr>
            </thead>
          </table>

            <p class="fw-bold text-primary">CLIENTES</p>
            <table id="tabla_clientes" class="display compact" style="width:100%">
              <thead>
                <tr>
                  <th>Id Cliente</th>
                  <th>RUC/CI</th>
                  <th>Nombre</th>
                  <th>Apellido</th>
                  <th>Dirección</th>
                  <th>Celular</th>
                </tr>
              </thead>
            </table>

            <p class="fw-bold text-primary">BANCOS</p>
            <table id="tabla_bancos" class="display compact" style="width:100%">
              <thead>
                <tr>
                  <th>Id Banco</th>
                  <th>Nombre</th>
                  <th>Dirección</th>
                  <th>Teléfono</th>
                </tr>
              </thead>
            </table>

            <p class="fw-bold text-primary">PAGOS A PROVEEDORES</p>
            <table id="tabla_pagosProveedores" class="display compact" style="width:100%">
              <thead>
                <tr>
                  <th>Id Pago</th>
                  <th>Id Compra</th>
                  <th>Monto</th>
                  <th>Fecha</th>
                  <!-- <th>Método</th> -->
                  <th>Banco</th>
                  <!-- <th>Motivo</th> -->
                </tr>
              </thead>
</table>


          
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>


  
  

  <script src="js/app.js"></script>
  <script src="js/bdP.js"></script>
  <!-- Datatables -->
  <script src="dt/jquery-3.7.1.js"></script>
  <script src="dt/datatables.min.js"></script>
  <script src="dt/es-ES.js"></script>

  <script>
    (()=>{
      'use strict'

      const forms=document.querySelectorAll('.needs-validation')

      Array.from(forms).forEach(form => {
        form.addEventListener('submit', event =>{
          if(!form.checkValidity()){
            event.preventDefault()
            event.stopPropagation()
          }

          form.classList.add('was-validated')
        }, false)
      })
    })()

    document.getElementById("login").addEventListener("submit", function(e){
      e.preventDefault();

      const usuarioIngresado=document.getElementById("usuario").value;
      const passwordIngresado=document.getElementById("contrasena").value;

      if(usuarioIngresado != "" && passwordIngresado != ""){

        const datosGuardados = localStorage.getItem("usuarios");
        const usuarios = JSON.parse(datosGuardados) || [];

        const usuarioEncontrado = usuarios.find(
          (u) => u.usuario === usuarioIngresado && u.contrasena === passwordIngresado
        );

        const mensaje = document.getElementById("mensaje");
        if (!usuarioEncontrado) {
          mensaje.textContent = "Usuario o contraseña incorrectos.";
          mensaje.style.color = "blue";
          document.getElementById("usuario").focus();
          setTimeout(function() { //Mostrar el mensaje de error por 2 segundos
            mensaje.textContent = "";
          }, 2000);
        }else{
          localStorage.setItem("nomUsuario", usuarioEncontrado.nombre);
          localStorage.setItem("rolUsuario", usuarioEncontrado.rol);
          localStorage.setItem("idUsuario", usuarioEncontrado.idusuario);
          sessionStorage.setItem("sesionActiva","true");
          window.location.href = "menu.html";
        }
      }
    });

    //-----------------------------------------------------
    function cargarBD(){
      datos();
      alertify.success("Base de datos original cargada");
    }
    //-----------------------------------------------------
    function vaciarBD(){
      localStorage.clear();
      alertify.error("Base de datos eliminada");
    }
    //-----------------------------------------------------
    function verBD(){
      var usuarios= JSON.parse(localStorage.getItem("usuarios")) || [];

      if($.fn.DataTable.isDataTable("#tabla_usuarios")){
        $('#tabla_usuarios').DataTable().clear().destroy();
      }

      tabla= new DataTable("#tabla_usuarios",{
        data: usuarios,
        columns:[
          {data: 'idusuario', title: 'ID Usuario'},
          {data: 'cedula', title: 'Cedula de Identidad'},
          {data: 'nombre', title: 'Nombre'},
          {data: 'celular', title: 'Celular'},
          {data: 'usuario', title: 'Usuario'},
          {data: 'contrasena', title: 'Contraseña'},
          {data: 'rol', title: 'Cargo'}
        ],
        language: spanish,
        searching: false,    
        lengthChange: false, 
        pageLength: 5 
      });


      // Recuperar el array de objetos desde localStorage. PROVEEDORES
      var proveedores = JSON.parse(localStorage.getItem("proveedores")) || [];

      // Si ya existe una instancia de DataTable, destruirla
      if ($.fn.DataTable.isDataTable("#tabla_proveedores")) {
        $('#tabla_proveedores').DataTable().clear().destroy();
      }

      // Inicializar el DataTable
      tabla = new DataTable("#tabla_proveedores", {
        data: proveedores,
        columns: [
          { data: 'idproveedor', title: 'Id Proveedor' },
          { data: 'ruc', title: 'RUC' },
          { data: 'nombre', title: 'Razón Social' },
          { data: 'direccion', title: 'Dirección' },
          { data: 'celular', title: 'Teléfono' },
          { data: 'ciudad', title: 'Ciudad' }
        ],
        language: spanish,
        searching: false,    
        lengthChange: false, 
        pageLength: 5        
      });


      // Recuperar el array de objetos desde localStorage. MARCAS
      var marcas = JSON.parse(localStorage.getItem("marcas")) || [];
            
      // Si ya existe una instancia de DataTable, destruirla
      if ($.fn.DataTable.isDataTable("#tabla_marcas")) {
        $('#tabla_marcas').DataTable().clear().destroy();
      }

      // Inicializar el DataTable
      tabla = new DataTable("#tabla_marcas", {
        data: marcas,
        columns: [
          { data: 'idmarca', title: 'Id Marca' },
          { data: 'marca', title: 'Marca' }
        ],
        language: spanish,
        searching: false,    //Oculta el buscador
        lengthChange: false, //Oculta el selector de cantidad de registros por página
        pageLength: 5        //Número de registros por página
      });


      // Recuperar el array de objetos desde localStorage. CLASIFICACIONES
      var clasificaciones = JSON.parse(localStorage.getItem("clasificaciones")) || [];
            
      // Si ya existe una instancia de DataTable, destruirla
      if ($.fn.DataTable.isDataTable("#tabla_clasificaciones")) {
          $('#tabla_clasificaciones').DataTable().clear().destroy();
      }

      // Inicializar el DataTable
      tabla = new DataTable("#tabla_clasificaciones", {
        data: clasificaciones,
        columns: [
          { data: 'idclasificacion', title: 'Id Clasificacion' },
          { data: 'clasificacion', title: 'Clasificacion' }
        ],
        language: spanish,
        searching: false,    //Oculta el buscador
        lengthChange: false, //Oculta el selector de cantidad de registros por página
        pageLength: 5        //Número de registros por página
      });


      // Recuperar el array de objetos desde localStorage. ARTICULOS. MARCAS. CLASIFICACIONES
      var articulos = JSON.parse(localStorage.getItem("articulos")) || [];
      var marcas = JSON.parse(localStorage.getItem("marcas")) || [];
      var clasificaciones = JSON.parse(localStorage.getItem("clasificaciones")) || [];
      
      // Si ya existe una instancia de DataTable, destruirla
      if ($.fn.DataTable.isDataTable("#tabla_articulos")) {
        $('#tabla_articulos').DataTable().clear().destroy();
      }

      // Crear diccionarios para acceso rápido por ID
      var dicMarcas = {};
      marcas.forEach(m => dicMarcas[m.idmarca] = m.marca);

      var dicClasificaciones = {};
      clasificaciones.forEach(c => dicClasificaciones[c.idclasificacion] = c.clasificacion);

      // Reemplazar los idmarca e idclasificacion por los nombres en artículos
      var articulosConNombres = articulos.map(a => {
        return {
          ...a,
          marca: dicMarcas[a.idmarca] || "Desconocido",
          clasificacion: dicClasificaciones[a.idclasificacion] || "Desconocido"
        };
      });

      tabla = new DataTable("#tabla_articulos",{
        data: articulosConNombres,
        columns:[
          { data: 'idarticulo', title: 'Id Artículo' },
          { data: 'codbarra', title: 'Código de Barras' },
          { data: 'descripcion', title: 'Descripción' },
          { data: 'marca', title: 'Marca' },
          { data: 'clasificacion', title: 'Clasificación' },
          {
            data: 'tiva',
            title: 'I.V.A.',
            render: function(data, type, row) {
              if (data === 0) return "EXENTA";
              if (data === 5) return "5%";
              if (data === 10) return "10%";
              return data; // en caso de valor inesperado
            }
          },
          {
            data: 'stockactual',
            title: 'Stock Actual',
            render: function(data, type, row) {
              let num = parseFloat(data).toFixed(2); // 2 decimales
              return num.replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            }
          },
          {
            data: 'preventa',
            title: 'Precio Venta',
            render: function(data, type, row) {
              return parseInt(data).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            }
          }
        ],
        language: spanish,
        searching: false,
        lengthChange: false,
        pageLength: 5
      });

      // Recuperar el array de objetos desde localStorage. COMPRAS
      var comprascabecera = JSON.parse(localStorage.getItem("compras")) || [];
      var proveedores = JSON.parse(localStorage.getItem("proveedores")) || [];

      // Si ya existe una instancia de DataTable, destruirla
      if ($.fn.DataTable.isDataTable("#tabla_comprascabecera")) {
        $('#tabla_comprascabecera').DataTable().clear().destroy();
      }

      // Crear diccionario para reemplazar idproveedor por razonsocial
      var dicProveedores = {};
      proveedores.forEach(p => dicProveedores[p.idproveedor] = p.nombre);

      // Reemplazar idproveedor por razonsocial
      var comprasConProveedor = comprascabecera.map(c => {
        return {
          ...c,
          proveedor: c.proveedor || dicProveedores[c.idproveedor] || "Desconocido",
          FechaCompra: c.FechaCompra || c.fecha || "",
          stexenta: c.stexenta ?? c.stexenta ?? 0,
          stiva5: c.stiva5 ?? c.stiva5 ?? 0,
          stiva10: c.stiva10 ?? c.stiva10 ?? 0,
          totcompra: c.totcompra ?? c.total ?? 0,
          liqiva5: c.liqiva5 ?? c.liq5 ?? 0,
          liqiva10: c.liqiva10 ?? c.liq10 ?? 0,
          totiva: c.totiva ?? c.totiva ?? 0,
          saldo: c.saldo ?? 0
        };
      });

tabla = new DataTable("#tabla_comprascabecera",{
  data: comprasConProveedor,
  scrollX: true,
  columns:[
    { data: 'idcompra', title: 'ID Compra', width: '85px' },
    { data: 'proveedor', title: 'Proveedor', width: '250px' },
    { data: 'numfactura', title: 'N° Factura', width: '100px' },
    {
      data: 'FechaCompra',
      title: 'Fec. Compra',
      width: '90px',
      render: function(data, type, row) {
        if (!data) return "";
        const partes = data.split('-');
        return `${partes[2]}/${partes[1]}/${partes[0]}`;
      }
    },
    { data: 'condicion', title: 'Condición', width: '85px' },
    {
      data: 'stexenta',
      title: 'Sub. Exenta',
      width: '90px',
      className: 'text-end',
      render: function(data, type, row) {
        return parseInt(data).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      }
    },
    {
      data: 'stiva5',
      title: 'Sub. I.V.A. 5%',
      width: '105px',
      className: 'text-end',
      render: function(data, type, row) {
        return parseInt(data).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      }
    },
    {
      data: 'stiva10',
      title: 'Sub. I.V.A. 10%',
      width: '115px',
      className: 'text-end',
      render: function(data, type, row) {
        return parseInt(data).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      }
    },
    {
      data: 'totcompra',
      title: 'Total',
      width: '100px',
      className: 'text-end',
      render: function(data, type, row) {
        return parseInt(data).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      }
    },
    {
      data: 'liqiva5',
      title: 'Liq. I.V.A. 5%',
      width: '100px',
      className: 'text-end',
      render: function(data, type, row) {
        return parseInt(data).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      }
    },
    {
      data: 'liqiva10',
      title: 'Liq. I.V.A. 10%',
      width: '110px',
      className: 'text-end',
      render: function(data, type, row) {
        return parseInt(data).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      }
    },
    {
      data: 'totiva',
      title: 'Tot. I.V.A.',
      width: '100px',
      className: 'text-end',
      render: function(data, type, row) {
        return parseInt(data).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      }
    },
    {
      data: 'saldo',
      title: 'Saldo',
      width: '100px',
      className: 'text-end',
      render: function(data, type, row) {
        return parseInt(data).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      }
    },
    { data: 'anulado', title: 'Anulado', width: '80px', className: 'text-center' },
    {
      data: null,
      title: 'Detalle',
      orderable: false,
      render: function(data, type, row) {
        return `<button class="btn btn-warning btn-sm btn-detalle-compra" data-id="${row.idcompra}">Detalle</button>`;
      }
    }
  ],
  language: spanish,
  searching: false,
  lengthChange: false,
  pageLength: 5
});
          var clientes = JSON.parse(localStorage.getItem("clientes")) || [];
    if ($.fn.DataTable.isDataTable("#tabla_clientes")) {
      $('#tabla_clientes').DataTable().clear().destroy();
    }
    tabla = new DataTable("#tabla_clientes", {
      data: clientes,
      columns: [
        { data: 'idcliente', title: 'Id Cliente' },
        { data: 'ciruc', title: 'RUC/CI' },
        { data: 'nombre', title: 'Nombre' },
        { data: 'apellido', title: 'Apellido' },
        { data: 'direccion', title: 'Dirección' },
        { data: 'celular', title: 'Celular' }
      ],
      language: spanish,
      searching: false,
      lengthChange: false,
      pageLength: 5
    });

    // BANCOS
    var bancos = JSON.parse(localStorage.getItem("bancos")) || [];
    if ($.fn.DataTable.isDataTable("#tabla_bancos")) {
      $('#tabla_bancos').DataTable().clear().destroy();
    }
    tabla = new DataTable("#tabla_bancos", {
      data: bancos,
      columns: [
        { data: 'idbanco', title: 'Id Banco' },
        { data: 'nombre', title: 'Nombre' },
        { data: 'direccion', title: 'Dirección' },
        { data: 'telefono', title: 'Teléfono' }
      ],
      language: spanish,
      searching: false,
      lengthChange: false,
      pageLength: 5
    });

    // PAGOS A PROVEEDORES
    var pagosProveedores = JSON.parse(localStorage.getItem("pagosProveedores")) || [];
    if ($.fn.DataTable.isDataTable("#tabla_pagosProveedores")) {
      $('#tabla_pagosProveedores').DataTable().clear().destroy();
    }
    tabla = new DataTable("#tabla_pagosProveedores", {
      data: pagosProveedores,
      columns: [
        { data: 'idpago', title: 'Id Pago' },
        { data: 'idcompra', title: 'Id Compra' },
        { 
          data: 'monto', 
          title: 'Monto',
          render: function(data) {
            return parseInt(data).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
          }
        },
        { data: 'fechapago', title: 'Fecha' },
        // { data: 'metodo', title: 'Método' },
        { data: 'idbanco', title: 'Banco' }
        // { data: 'motivo', title: 'Motivo' }
      ],
      language: spanish,
      searching: false,
      lengthChange: false,
      pageLength: 5
    });


var detalleCompras = JSON.parse(localStorage.getItem("comprasdetalle")) || [];
var articulos = JSON.parse(localStorage.getItem("articulos")) || [];

// Enriquecer los detalles con codbarra y descripcion
detalleCompras = detalleCompras.map(det => {
  var art = articulos.find(a => a.idarticulo == det.idarticulo) || {};
  return {
    ...det,
    codbarra: art.codbarra || "",
    descripcion: art.descripcion || ""
  };
});

if ($.fn.DataTable.isDataTable("#tabla_detallecompras")) {
  $('#tabla_detallecompras').DataTable().clear().destroy();
}
tabla = new DataTable("#tabla_detallecompras", {
  data: detalleCompras,
  columns: [
    { data: 'idcompra', title: 'Id Compra' },
    { data: 'idarticulo', title: 'Id Artículo' },
    { data: 'codbarra', title: 'Código Barra' },
    { data: 'descripcion', title: 'Descripción' },
    { data: 'cantidad', title: 'Cantidad' },
    { data: 'preuni', title: 'Precio Unitario',
      render: function(data) {
        return parseInt(data).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      }
    },
    { data: 'subtotal', title: 'Subtotal',
      render: function(data) {
        return parseInt(data).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      }
    },
    { data: 'exenta', title: 'Exenta',
      render: function(data) {
        return parseInt(data).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      }
    },
    { data: 'iva5', title: 'IVA 5%',
      render: function(data) {
        return parseInt(data).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      }
    },
    { data: 'iva10', title: 'IVA 10%',
      render: function(data) {
        return parseInt(data).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      }
    }
  ],
  language: spanish,
  searching: false,
  lengthChange: false,
  pageLength: 5
});

// Recuperar el array de objetos desde localStorage. VENTAS
var ventas = JSON.parse(localStorage.getItem("ventas")) || [];
if ($.fn.DataTable.isDataTable("#tabla_ventas")) {
  $('#tabla_ventas').DataTable().clear().destroy();
}
tabla = new DataTable("#tabla_ventas", {
  data: ventas.map(v => ({
    factura: v.factura,
    fecha: v.fecha ? new Date(v.fecha).toLocaleString() : "",
    cliente: v.cliente,
    total: v.total?.toLocaleString() ?? "",
    iva: v.iva?.toLocaleString() ?? "",
    condicion: v.condicion ?? "",
    estado: v.anulada ? "Anulada" : "Exitosa",
    detalle: v.detalle || [],
  })),
  columns: [
    { data: 'factura', title: 'Factura' },
    { data: 'fecha', title: 'Fecha' },
    { data: 'cliente', title: 'Cliente' },
    { data: 'total', title: 'Total' },
    { data: 'iva', title: 'IVA' },
    { data: 'condicion', title: 'Condición' },
    { data: 'estado', title: 'Estado' },
    {
      data: null,
      title: 'Detalle',
      orderable: false,
      render: function(data, type, row) {
        return `<button class="btn btn-info btn-sm btn-detalle-venta" data-factura="${row.factura}">Detalle</button>`;
      }
    }
  ],
  language: spanish,
  searching: false,
  lengthChange: false,
  pageLength: 5
});
    }
    
// Evento delegado para el botón Detalle en la tabla de compras
$(document).on('click', '.btn-detalle-compra', function() {
  const idcompra = $(this).data('id');
  mostrarDetalleCompraModal(idcompra);
});

// Evento delegado para el botón Detalle en la tabla de compras
$(document).on('click', '.btn-detalle-compra', function() {
  const idcompra = $(this).data('id');
  mostrarDetalleCompraModal(idcompra);
});


function mostrarDetalleCompraModal(idcompra) {
  const comprasdetalle = JSON.parse(localStorage.getItem("comprasdetalle")) || [];
  const articulos = JSON.parse(localStorage.getItem("articulos")) || [];
  const detalle = comprasdetalle.filter(d => d.idcompra == idcompra);
  let filas = "";
  detalle.forEach(d => {
    const art = articulos.find(a => a.idarticulo == d.idarticulo) || {};
    filas += `
      <tr>
        <td>${d.idarticulo}</td>
        <td>${art.codbarra ?? ""}</td>
        <td>${art.descripcion ?? ""}</td>
        <td>${d.cantidad}</td>
        <td>${parseInt(d.preuni).toLocaleString("es-PY")}</td>
        <td>${parseInt(d.subtotal).toLocaleString("es-PY")}</td>
        <td>${parseInt(d.exenta ?? 0).toLocaleString("es-PY")}</td>
        <td>${parseInt(d.iva5 ?? 0).toLocaleString("es-PY")}</td>
        <td>${parseInt(d.iva10 ?? 0).toLocaleString("es-PY")}</td>
      </tr>
    `;
  });
  document.getElementById("detalle_compra_modal").innerHTML = filas;
  // Ahora muestra el modal de detalle
  const modal = new bootstrap.Modal(document.getElementById('modalDetalleCompra'));
  modal.show();
}
// Evento delegado para el botón Detalle en la tabla de ventas
$(document).on('click', '.btn-detalle-venta', function() {
  const factura = $(this).data('factura');
  mostrarDetalleVentaModal(factura);
});

function mostrarDetalleVentaModal(factura) {
  const ventas = JSON.parse(localStorage.getItem("ventas")) || [];
  const venta = ventas.find(v => v.factura == factura);
  let filas = "";
  if (venta && Array.isArray(venta.detalle)) {
    venta.detalle.forEach(d => {
      filas += `
        <tr>
          <td>${d.descripcion ?? ""}</td>
          <td>${d.cantidad ?? ""}</td>
          <td>${parseInt(d.precio ?? 0).toLocaleString("es-PY")}</td>
          <td>${parseInt(d.subtotal ?? 0).toLocaleString("es-PY")}</td>
          <td>${parseInt(d.totalIva ?? 0).toLocaleString("es-PY")}</td>
        </tr>
      `;
    });
  }
  document.getElementById("detalle_venta_modal").innerHTML = filas;
  const modal = new bootstrap.Modal(document.getElementById('modalDetalleVenta'));
  modal.show();
}
    window.addEventListener('storage', function(e) {
  if (
    e.key === 'compras' ||
    e.key === 'comprasdetalle' ||
    e.key === 'ventas'
    
  ) {
    // Si el modal está abierto, vuelve a cargar los datos
    if ($('#verBD').hasClass('show')) {
      verBD();
    }
  }
});

// Cierra el modal y elimina el backdrop si queda pegado
$('#verBD').on('hidden.bs.modal', function () {
  $('.modal-backdrop').remove();
  $('body').removeClass('modal-open');
});
</script>

<div class="modal fade" id="modalDetalleCompra" tabindex="-1" aria-labelledby="modalDetalleCompraLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalDetalleCompraLabel">Detalle de la Compra</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <table class="table table-bordered table-sm">
          <thead>
            <tr>
              <th>ID Artículo</th>
              <th>Código Barra</th>
              <th>Descripción</th>
              <th>Cantidad</th>
              <th>Precio Unitario</th>
              <th>Subtotal</th>
              <th>Exenta</th>
              <th>IVA 5%</th>
              <th>IVA 10%</th>
            </tr>
          </thead>
          <tbody id="detalle_compra_modal"></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Detalle de Venta -->
<div class="modal fade" id="modalDetalleVenta" tabindex="-1" aria-labelledby="modalDetalleVentaLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalDetalleVentaLabel">Detalle de la Venta</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <table class="table table-bordered table-sm">
          <thead>
            <tr>
              <th>Descripción</th>
              <th>Cantidad</th>
              <th>Precio</th>
              <th>Subtotal</th>
              <th>IVA</th>
            </tr>
          </thead>
          <tbody id="detalle_venta_modal"></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
   
</body>
</html>

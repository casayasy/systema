<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Venta</title>
   
    <!-- ALERTIFYJS -->
    <link rel="stylesheet" href="alert/alertify.min.css">
    <link rel="stylesheet" href="alert/themes/default.min.css">
    <script src="alert/alertify.min.js"></script>
    <link href="menu/styles.css" rel="stylesheet" />

    <link rel="stylesheet" href="bt/bootstrap.min.css">
</head>

<body class="bg-light p-4">


    <div class="container bg-white p-4 rounded shadow-sm">
        <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="text-white bg-danger p-3 rounded mb-0">Venta</h2>
    <a href="menu.html" class="btn btn-outline-primary ms-3">Menú Principal</a>
</div>
        

        <div class="mb-3">
            <label for="factura" class="form-label">Nº de Factura</label>
            <input type="text" class="form-control" id="factura" readonly>
        </div>

        <div class="mb-3">
            <label for="ruc" class="form-label">RUC/CI del Cliente</label>
            <input type="text" required autofocus id="ruc" class="form-control" autocomplete="off" />
        </div>


        <div class="mb-3">
            <label for="NombreCliente" class="form-label">Razón Social</label>
            <input type="text" required id="NombreCliente" oninput="this.value = this.value.toUpperCase();"
                class="form-control">
        </div>
        <button onclick="window.location.href='clientes.html'">Nuevo Cliente</button>


        <div class="col-md-3 mb-2">
            <label>Condición</label>
            <select class="form-select" id="condicionVenta">
                <option value="Contado">Contado</option>
                <option value="Crédito">Crédito</option>
            </select>
        </div>

        

        <div class="row">
            <div class="col-md-3 mb-2">
                <label>Timbrado</label>
                <input type="text" required class="form-control" id="timbrado">
            </div>
            <div class="col-md-3 mb-2">
                <label>Fecha</label>
                <input type="date" class="form-control" id="vigencia" readonly>
            </div>
            <div class="col-md-3 mb-2">
                <label>Total IVA</label>
                <input type="text" class="form-control" id="totalIvaGeneral" readonly>
            </div>
            <div class="col-md-3 mb-2">
                <label>Total</label>
                <input type="text" class="form-control" id="totalGeneral" readonly>
            </div>
        </div>

        <div class="mt-3">
            <button class="btn btn-primary me-2" onclick="crearVenta()">Crear Venta</button>
            <button onclick="guardarVenta()" type="button" class="btn btn-success">
                Guardar Venta
            </button>

            <button class="btn btn-danger" onclick="cancelarVenta()">Cancelar</button>
        </div>
    </div>

    <!-- Detalle Producto -->
    <div class="container mt-4">
        <div class="row g-3">
            <div class="col-md-2">
                <label for="codigo" class="form-label">Código</label>
                <input type="text" class="form-control" id="codigo" list="codigos" oninput="mostrarProductoPorCodigo()"
                    onchange="buscarProductoPorCodigo()">
                <datalist id="codigos"></datalist>
            </div>
            <div class="col-md-4">
                <label for="descripcion" class="form-label">Descripción</label>
                <input type="text" class="form-control" id="descripcion" list="listaProductos"
                    oninput="buscarProductoPorDescripcion()" onchange="actualizarDatosProducto()">
                <datalist id="listaProductos"></datalist>
            </div>

            <div class="col-md-2">
                <label for="tipoIva" class="form-label">IVA</label>
                <select disabled class="form-select" id="tipoIva" onchange="calcularTotal()">
                    <option value="0">Exento</option>
                    <option value="5">5%</option>
                    <option value="10">10%</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="cantidad" class="form-label">Cantidad</label>
                <input type="number" class="form-control" min="1" id="cantidad" onchange="calcularTotal()">
            </div>
            <div class="col-md-2">
                <label for="precio" class="form-label">Precio</label>
                <input type="number" readonly class="form-control" id="precio" onchange="calcularTotal()">
            </div>
            <div class="col-md-2">
                <label for="totalIvaDetalle" class="form-label">Total IVA</label>
                <input type="text" class="form-control" id="totalIvaDetalle" readonly>
            </div>
            <div class="col-md-2">
                <label for="subtotal" class="form-label">Subtotal</label>
                <input type="text" class="form-control" id="subtotal" readonly>
            </div>
        </div>

        <div class="mt-3">
            <button id="btnAgregar" class="btn btn-primary" onclick="agregarProducto()">Cargar pedido</button>
        </div>
    </div>

    <!-- Tabla Productos Cargados -->
    <div class="container mt-4">
        <h5>Productos cargados</h5>
        <table class="table table-bordered table-sm">
            <thead class="table-light">
                <tr>
                    <th>Descripción</th>
                    <th>Código</th>
                    <th>IVA (%)</th>
                    <th>Cantidad</th>
                    <th>Precio</th>
                    <th>Total IVA</th>
                    <th>Subtotal</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody id="tablaDetalleTemp"></tbody>
        </table>
    </div>
    <div class="container mt-5">
        <h4>Detalle de Ventas</h4>
        <table class="table table-bordered table-sm">
            <thead class="table-secondary">
                <tr>
                    <th>Factura</th>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>Total</th>
                    <th>IVA</th>
                    <th>Detalle</th>
                </tr>
            </thead>
            <tbody id="tablaVentas"></tbody>
        </table>
    </div>


    <!-- Modal para agregar nuevo cliente -->
    <div class="modal fade" id="modalCliente" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Registrar Nuevo Cliente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label for="nuevoRuc" class="form-label">RUC (Ej: 1234567-0)</label>
                    <input type="text" class="form-control" id="nuevoRuc">

                    <label for="nuevoNombre" class="form-label mt-2">Nombre y Apellido</label>
                    <input type="text" class="form-control" id="nuevoNombre">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button class="btn btn-danger" onclick="guardarCliente()">Guardar Cliente</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal de Pago -->
    <div class="modal fade" id="modalPago" tabindex="-1" aria-labelledby="modalPagoLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalPagoLabel">Pago en Efectivo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <p>Total a pagar: <strong id="totalPagarTexto">Gs. 0</strong></p>
                    <div class="form-group mb-3">
                        <label for="pagoCliente">Pago del cliente</label>
                        <input type="number" class="form-control" id="pagoCliente" placeholder="Ingrese monto recibido"
                            oninput="calcularVuelto()">
                    </div>
                    <div class="form-group">
                        <label for="vuelto">Vuelto</label>
                        <input type="text" class="form-control" id="vuelto" disabled>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="confirmarPago()">Confirmar y Guardar
                        Venta</button>
                </div>
            </div>
        </div>
    </div>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalProductos">
        Ver Productos
    </button>
    <div class="modal fade" id="modalProductos" tabindex="-1" aria-labelledby="tituloModalProductos" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tituloModalProductos">Lista de Productos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Código</th>
                                <th>Descripción</th>
                                <th>Precio</th>
                                <th>Stock</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpoProductos">
                            <!-- Se cargan los productos aquí -->
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Informe de Ventas -->
    <div class="modal fade" id="modalInforme" tabindex="-1" aria-labelledby="modalInformeLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalInformeLabel">Informe de Ventas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">

                    <form id="formFiltrosInforme" class="row g-3 mb-3">
                        <div class="col-md-3">
                            <label for="filtroDesde" class="form-label">Fecha Desde</label>
                            <input type="date" class="form-control" id="filtroDesde">
                        </div>
                        <div class="col-md-3">
                            <label for="filtroHasta" class="form-label">Fecha Hasta</label>
                            <input type="date" class="form-control" id="filtroHasta">
                        </div>
                        <div class="col-md-3">
                            <label for="filtroCondicion" class="form-label">Condición</label>
                            <select id="filtroCondicion" class="form-select">
                                <option value="">Todas</option>
                                <option value="contado">Contado</option>
                                <option value="credito">Crédito</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filtroEstado" class="form-label">Estado</label>
                            <select id="filtroEstado" class="form-select">
                                <option value="">Todas</option>
                                <option value="exitosa">Exitosa</option>
                                <option value="anulada">Anulada</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <button type="button" class="btn btn-primary" onclick="aplicarFiltrosInforme()">Aplicar
                                filtros</button>
                            <button type="button" class="btn btn-secondary"
                                onclick="resetearFiltrosInforme()">Restablecer filtros</button>
                        </div>
                    </form>

                    <div class="table-responsive">
                        <table class="table table-bordered table-striped" id="tablaInformeVentas">
                            <thead>
                                <tr>
                                    <th>Factura</th>
                                    <th>Fecha</th>
                                    <th>Cliente</th>
                                    <th>Total</th>
                                    <th>IVA</th>
                                    <th>Condición</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="cuerpoInformeVentas">
                                <!-- Aquí van las filas que mostraremos -->
                            </tbody>
                        </table>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
                <div class="d-flex justify-content-end gap-2 mt-3">
                    <button class="btn btn-success" onclick="exportarExcel()">Exportar a Excel</button>
                    <button class="btn btn-danger" onclick="exportarPDF()">Exportar a PDF</button>
                </div>

            </div>
        </div>
    </div>
    <button class="btn btn-info" onclick="abrirModalInforme()">Ver Informe de Ventas</button>

    <!-- PIE DE PAGINA -->
    <footer class="py-4 bg-light mt-auto">
        <div class="container-fluid px-4">
            <div class="d-flex align-items-center justify-content-between small">
                <div class="text-muted">Copyright &copy; Your Website 2025</div>
                <div>
                    <a href="#">Política de Privacidad</a>
                    &middot;
                    <a href="#">Terminos &amp; Condiciones</a>
                </div>
            </div>
        </div>
    </footer>
    </div>
    <script>

        // Verificar si existe sesión activa
        if (!sessionStorage.getItem("sesionActiva")) {
            localStorage.removeItem("nomUsuario");
            localStorage.removeItem("rolUsuario");
            window.location.href = "Pagerror.html";
        }

        let ventas = JSON.parse(localStorage.getItem("ventas")) || [];
        let productos = JSON.parse(localStorage.getItem("articulos")) || [];
        let clientes = JSON.parse(localStorage.getItem("clientes")) || [];
        let detalleVenta = [];
        let numeroFactura = parseInt(localStorage.getItem('numeroFactura')) || 1000;
        let indexEditando = null;

        const modalProductos = document.getElementById('modalProductos');
        modalProductos.addEventListener('show.bs.modal', mostrarProductos);

        window.onload = () => {
            if (!localStorage.getItem("numeroFactura")) {
                localStorage.setItem("numeroFactura", 1000);
            }
            generarNumeroFactura();
            cargarProductos();
            establecerFechaVigencia();
            mostrarVentas();
        };

        document.getElementById('ruc').addEventListener('input', function () {
            // Solo permite números y guiones
            this.value = this.value.replace(/[^0-9\-]/g, '');
        });

        function validarCampos() {
            const ruc = document.getElementById('ruc').value.trim();
            const cliente = document.getElementById('NombreCliente').value.trim();

            if (ruc === '' || cliente === '') {
                alertify.error("Complete todos los campos.");
                return false;
            }
            return true;
        }


        function generarNumeroFactura() {
            const formato = `001-001-${numeroFactura.toString().padStart(7, '0')}`;
            document.getElementById("factura").value = formato;
        }

        function establecerFechaVigencia() {
            const hoy = new Date();
            const anio = hoy.getFullYear();
            const mes = String(hoy.getMonth() + 1).padStart(2, '0'); // Mes comienza en 0
            const dia = String(hoy.getDate()).padStart(2, '0');

            document.getElementById("vigencia").value = `${anio}-${mes}-${dia}`;
        }


        function cargarProductos() {
            const listaProductos = document.getElementById("listaProductos");
            const listaCodigos = document.getElementById("codigos");
            listaProductos.innerHTML = "";
            listaCodigos.innerHTML = "";

            productos.forEach(p => {
                listaProductos.innerHTML += `<option value="${p.descripcion}">`;
                listaCodigos.innerHTML += `<option value="${p.codbarra}">`;
            });
        }

        function buscarProductoPorDescripcion() {
            const desc = document.getElementById("descripcion").value.toLowerCase();
            const p = productos.find(p => p.descripcion.toLowerCase() === desc);
            if (p) completarCamposProducto(p);
        }

        function buscarProductoPorCodigo() {
            const cod = document.getElementById("codigo").value;
            const p = productos.find(p => p.codbarra === cod);
            if (p) completarCamposProducto(p);
        }

        function completarCamposProducto(p) {
            document.getElementById("codigo").value = p.codbarra;
            document.getElementById("descripcion").value = p.descripcion;
            document.getElementById("precio").value = p.preventa;
            document.getElementById("tipoIva").value = p.tiva;
            calcularTotal();
        }

        function calcularTotal() {
            const cantidad = parseInt(document.getElementById("cantidad").value) || 0;
            const precio = parseFloat(document.getElementById("precio").value) || 0;
            const iva = parseInt(document.getElementById("tipoIva").value);
            const subtotal = cantidad * precio;
            const totalIva = iva ? subtotal * (iva / 100) : 0;

            document.getElementById("subtotal").value = subtotal.toFixed(2);
            document.getElementById("totalIvaDetalle").value = totalIva.toFixed(2);
        }
        function agregarProducto() {
            const campos = ["descripcion", "codigo", "tipoIva", "cantidad", "precio", "subtotal", "totalIvaDetalle"];
            const [descripcion, codigo, tipoIva, cantidad, precio, subtotal, totalIva] = campos.map(id => document.getElementById(id).value);
            

            if (!descripcion || !cantidad || !precio) {
                alertify.error("Complete todos los campos del producto.");
                return;
            }

            if (cantidad <=0) {
                alertify.error("Debe poner una cantidad positiva.");
                return;
            }

            const cantidadNum = parseInt(cantidad);

            // Buscar producto en productos para validar stock
            const productoEnStock = productos.find(p => p.codbarra === codigo);
            if (!productoEnStock) {
                alertify.error("Producto no encontrado en inventario.");
                return;
            }

            // Calcular la cantidad ya agregada en detalleVenta para este código (excepto si estamos editando ese índice)
            let cantidadAgregada = 0;
            detalleVenta.forEach((item, idx) => {
                if (item.codigo === codigo && idx !== indexEditando) {
                    cantidadAgregada += item.cantidad;
                }
            });

            // Usar stockactual si existe, sino fallback a stock
            const stockDisponible = productoEnStock.stockactual !== undefined ? productoEnStock.stockactual : productoEnStock.stock;

            if (cantidadNum + cantidadAgregada > stockDisponible) {

                alertify.error(`Stock insuficiente.`);
                return;
            }

            const producto = {
                descripcion,
                codigo,
                tipoIva,
                cantidad: cantidadNum,
                precio: parseFloat(precio),
                subtotal: parseFloat(subtotal),
                totalIva: parseFloat(totalIva)
            };

            if (indexEditando !== null) {
                detalleVenta[indexEditando] = producto;
                indexEditando = null;
                actualizarBotonAgregar("Cargar pedido", "btn-primary", "btn-warning");
            } else {
                detalleVenta.push(producto);
            }

            mostrarDetalleTemp();
            calcularTotalesGenerales();
            limpiarCamposProducto();
        }


        function actualizarBotonAgregar(texto, claseAgregar, claseQuitar) {
            const btn = document.getElementById("btnAgregar");
            btn.textContent = texto;
            btn.classList.add(claseAgregar);
            btn.classList.remove(claseQuitar);
        }

        function mostrarDetalleTemp() {
            const tabla = document.getElementById("tablaDetalleTemp");
            tabla.innerHTML = detalleVenta.map((item, index) => `
            <tr>
                <td>${item.descripcion}</td>
                <td>${item.codigo}</td>
                <td>${item.tipoIva}</td>
                <td>${item.cantidad}</td>
                <td>${item.precio}</td>
                <td>${item.totalIva.toFixed(2)}</td>
                <td>${item.subtotal.toFixed(2)}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="eliminarProducto(${index})">Eliminar</button>
                    <button class="btn btn-warning btn-sm me-1" onclick="editarProducto(${index})">Editar</button>
                </td>
            </tr>
        `).join("");
        }

        function editarProducto(index) {
            const item = detalleVenta[index];
            Object.entries(item).forEach(([key, val]) => {
                if (document.getElementById(key)) document.getElementById(key).value = val;
            });
            indexEditando = index;
            actualizarBotonAgregar("Actualizar", "btn-warning", "btn-primary");
        }

        function eliminarProducto(index) {
            detalleVenta.splice(index, 1);
            mostrarDetalleTemp();
            calcularTotalesGenerales();
        }

        function calcularTotalesGenerales() {
            let totalIva = 0, total = 0;
            detalleVenta.forEach(item => {
                total += item.subtotal;
                totalIva += item.totalIva;
            });

            document.getElementById("totalIvaGeneral").value = totalIva.toFixed(2);
            document.getElementById("totalGeneral").value = total.toFixed(2);
        }

        function limpiarCamposProducto() {
            ["descripcion", "codigo", "tipoIva", "cantidad", "precio", "subtotal", "totalIvaDetalle"].forEach(id => {
                document.getElementById(id).value = id === "tipoIva" ? "0" : "";
            });
        }

        function validarFormatoRuc(ruc) {
            const soloNumeros = /^\d{7,13}$/;
            const conGuion = /^\d{7,12}-\d{1}$/;
            return soloNumeros.test(ruc) || (conGuion.test(ruc) && ruc.length <= 13);
        }


        document.getElementById('ruc').addEventListener('blur', function () {
            const cirucValue = this.value.trim();
            if (!cirucValue) return;

            const clientes = JSON.parse(localStorage.getItem('clientes')) || [];
            const cliente = clientes.find(c => c.ciruc === cirucValue);

            if (cliente) {
                document.getElementById('NombreCliente').value = cliente.nombre + ' ' + cliente.apellido;
            } else {
                document.getElementById('NombreCliente').value = '';
                alertify.error('Cliente no registrado.');
                // window.location.href = 'registro_clientes.html';
            }
        });
        const modalPago = document.getElementById('modalPago');
        modalPago.addEventListener('show.bs.modal', function () {
            const total = parseFloat(document.getElementById("totalGeneral").value) || 0;
            document.getElementById("totalPagarTexto").textContent = `Gs. ${total.toLocaleString()}`;
            document.getElementById("pagoCliente").value = '';
            document.getElementById("vuelto").value = '';
        });

        function calcularVuelto() {
            const pago = parseFloat(document.getElementById("pagoCliente").value) || 0;
            const total = parseFloat(document.getElementById("totalGeneral").value) || 0;
            const vuelto = pago - total;
            document.getElementById("vuelto").value = vuelto >= 0 ? `Gs. ${vuelto.toLocaleString()}` : 'Pago insuficiente';
        }



        function crearVenta() {
            ["ruc", "NombreCliente", "timbrado", "totalIvaGeneral", "totalGeneral"].forEach(id => {
                document.getElementById(id).value = "";
            });
            detalleVenta = [];
            mostrarDetalleTemp();
            generarNumeroFactura();
            establecerFechaVigencia();
            limpiarCamposProducto();
        }
        function confirmarPago() {
            const pago = parseFloat(document.getElementById("pagoCliente").value) || 0;
            const total = parseFloat(document.getElementById("totalGeneral").value) || 0;
            if (pago < total) {
                alertify.error("El pago es insuficiente.");
                return;
            }

            // Datos de la venta
            const factura = document.getElementById("factura").value;
            const ruc = document.getElementById("ruc").value;
            const cliente = document.getElementById("NombreCliente").value;
            const iva = parseFloat(document.getElementById("totalIvaGeneral").value) || 0;
            const vuelto = pago - total;

            // Fecha completa en ISO
            const ahora = new Date().toISOString();

            const condicion = document.getElementById("condicionVenta").value || "contado"; // si tienes un select con id condicionVenta

            const venta = {
                factura,
                fecha: ahora,      // <-- guardamos fecha + hora
                ruc,
                cliente,
                total,
                iva,
                pago,
                vuelto,
                condicion,
                anulada: false,
                detalle: [...detalleVenta]
            };
            // Descontar stock de productos vendidos en base al array "articulos"
            let articulos = JSON.parse(localStorage.getItem("articulos")) || [];

            venta.detalle.forEach(itemVenta => {
                const articulo = articulos.find(p => p.codbarra === itemVenta.codigo);
                if (articulo) {
                    articulo.stockactual = (articulo.stockactual || 0) - itemVenta.cantidad;
                    if (articulo.stockactual < 0) articulo.stockactual = 0; // evitar negativos
                }
            });

            // Guardar el array "articulos" actualizado en localStorage
            localStorage.setItem("articulos", JSON.stringify(articulos));
            // Usamos el array global `ventas`, no redeclaramos
            ventas.push(venta);
            localStorage.setItem("ventas", JSON.stringify(ventas));

            alertify.success("Venta guardada exitosamente.");
            numeroFactura++;
            localStorage.setItem('numeroFactura', numeroFactura);
            mostrarVentas();
            imprimirFactura(venta);

            // Cerrar modal y limpiar
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalPago'));
            modal.hide();
            limpiarFormulario();
            
        }
        function limpiarFormulario() {
            // Limpiar campos del formulario principal
            document.getElementById("factura").value = '';
            document.getElementById("ruc").value = '';
            document.getElementById("NombreCliente").value = '';
            document.getElementById("pagoCliente").value = '';
            document.getElementById("timbrado").value = '';
            document.getElementById("totalGeneral").value = '0';
            document.getElementById("totalIvaGeneral").value = '0';
            document.getElementById("condicionVenta").value = 'contado';

            // Limpiar el detalle de venta (array global o lo que uses)
            detalleVenta = [];
            // También deberías actualizar la tabla o interfaz donde muestras el detalle de la venta
            mostrarDetalleVenta();  // Asegúrate de tener una función que refresque la tabla del detalle

            // Si tienes inputs para productos, stock, etc, también los limpias:
            document.getElementById("txtCodigo").value = '';
            document.getElementById("txtArticulo").value = '';
            document.getElementById("txtCosto").value = '';
            document.getElementById("txtPrecio1").value = '';
            document.getElementById("txtStock").value = '';
        }



        function guardarVenta() {
            if (!validarCampos()) return;

            if (detalleVenta.length === 0) {
                alertify.error('Debe agregar al menos un producto antes de guardar la venta.');
                return;
            }

            // Validar si el cliente existe
            const rucIngresado = document.getElementById('ruc').value.trim();
            const nombreIngresado = document.getElementById('NombreCliente').value.trim().toLowerCase();

            const clientes = JSON.parse(localStorage.getItem('clientes')) || [];

            const clienteExiste = clientes.some(c => {
                const nombreCompleto = (c.nombre + ' ' + c.apellido).toLowerCase();
                return c.ciruc === rucIngresado && nombreCompleto === nombreIngresado;
            });

            if (!clienteExiste) {
                alertify.error("El cliente no existe. Verifique el RUC y nombre.");
                return;
            }

            // ✅ Cliente válido, continuar con la venta
            const modal = new bootstrap.Modal(document.getElementById("modalPago"));
            modal.show();
        }




        function cancelarVenta() {
            detalleVenta = [];
            document.getElementById("ruc").value = "";
            document.getElementById("NombreCliente").value = "";
            document.getElementById("totalIvaGeneral").value = "";
            document.getElementById("totalGeneral").value = "";
            mostrarDetalleTemp();
            limpiarCamposProducto();
            generarNumeroFactura();
        }

        // Obtener el usuario activo desde localStorage de forma segura
        let usuarioActivo = { rol: "usuario", nombre: "Invitado" };
        const rolGuardado = localStorage.getItem("rolUsuario");
        if (rolGuardado) {
            usuarioActivo.rol = rolGuardado.toLowerCase();
            // opcionalmente también puedes guardar nombre en otro key o asumir "Invitado"
        }


        // Mostrar todas las ventas con botones según el rol y tiempo
        function mostrarVentas(lista = ventas) {
            const tabla = document.getElementById("tablaVentas");
            tabla.innerHTML = lista.map(v => {
                const creado = new Date(v.fecha);
                const ahora = new Date();
                const diffHrs = (ahora - creado) / (1000 * 60 * 60); // diferencia en horas
                const puedeAnular = diffHrs <= 24 && !v.anulada;
                const esAdmin = (usuarioActivo.rol || "").toLowerCase() === "administrador";

                // Venta ya anulada
                if (v.anulada) {
                    return `
                        <tr class="table-danger">
                        <td>${v.factura}</td>
                        <td>${creado.toLocaleDateString()} ${creado.toLocaleTimeString()}</td>
                        <td>${v.cliente}</td>
                        <td>${v.total.toFixed(2)}</td>
                        <td>${v.iva.toFixed(2)}</td>
                        <td>
                            <span class="text-danger">
                            Anulada por ${v.anuladaPor}<br><small>${new Date(v.fechaAnulacion).toLocaleString()}</small>
                            </span>
                        </td>
                        </tr>
                        `;
                }

                // Venta activa - mostrar botones según permisos
                return `
                    <tr>
                    <td>${v.factura}</td>
                    <td>${creado.toLocaleDateString()} ${creado.toLocaleTimeString()}</td>
                    <td>${v.cliente}</td>
                    <td>${v.total.toFixed(2)}</td>
                    <td>${v.iva.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick='verDetalle("${v.factura}")'>Ver</button>
                        ${esAdmin ? `
                        <button class="btn btn-${puedeAnular ? 'warning' : 'secondary'} btn-sm"
                                onclick='anularVenta("${v.factura}")'
                                ${puedeAnular ? '' : 'disabled'}>
                            Anular
                        </button>
                        ` : `<span class="text-muted">Anular</span>`}
                        ${!puedeAnular && esAdmin ? `<br><small class="text-muted">Venció el periodo para anular</small>` : ''}
                    </td>
                    </tr>
                    `;
            }).join("");
        }

        // Función para anular una venta, solo si es admin y dentro de 24 horas
        function anularVenta(factura) {
            if ((usuarioActivo.rol || "").toLowerCase() !== "administrador") {
                alertify.error("Solo el administrador puede anular ventas.");
                return;
            }

            const idx = ventas.findIndex(v => v.factura === factura);
            if (idx === -1) {
                alertify.error("Venta no encontrada.");
                return;
            }

            //let usuarioAnulador= localStorage.getItem("nomUsuario") 
            const venta = ventas[idx];
            const creado = new Date(venta.fecha);
            const diffHrs = (Date.now() - creado.getTime()) / 36e5;

            if (diffHrs > 24) {
                alertify.error("Ya expiró el plazo de 24 horas para anular esta venta.");
                mostrarVentas();
                return;
            }

            alertify.confirm(
                "Confirmar anulación",
                `¿Seguro quieres anular la factura ${factura}?`,
                () => {
                    ventas[idx].anulada = true;
                    ventas[idx].anuladaPor = usuarioActivo.nombre || "Administrador";
                    ventas[idx].fechaAnulacion = new Date().toISOString();

                    localStorage.setItem("ventas", JSON.stringify(ventas));
                    alertify.success(`Factura ${factura} anulada correctamente.`);
                    mostrarVentas();
                },
                () => {
                    alertify.message("Operación cancelada.");
                }
            );
        }


        function verDetalle(factura) {
            const venta = ventas.find(v => v.factura === factura);
            if (!venta) {
                alertify.error("Venta no encontrada.");
                return;
            }

            let texto = venta.detalle.map(p => `
            ${p.descripcion} - Cant: ${p.cantidad}, Subtotal: ${(Number(p.subtotal) || 0).toFixed(2)}, IVA: ${(Number(p.totalIva) || 0).toFixed(2)}
             `).join("\n");

            alertify.alert(`Detalle de factura ${venta.factura}`, texto);
        }


        function filtrarVentas() {
            const desde = document.getElementById("fechaDesde").value;
            const hasta = document.getElementById("fechaHasta").value;

            const filtradas = ventas.filter(v => {
                return (!desde || v.fecha >= desde) && (!hasta || v.fecha <= hasta);
            });

            mostrarVentas(filtradas);
        }

        function mostrarProductos() {
            const cuerpo = document.getElementById("cuerpoProductos");
            cuerpo.innerHTML = ""; // Limpiar contenido anterior

            const articulos = JSON.parse(localStorage.getItem("articulos")) || [];

            articulos.forEach(articulo => {
                const fila = document.createElement("tr");
                fila.innerHTML = `
            <td>${articulo.codbarra}</td>
            <td>${articulo.descripcion}</td>
            <td>${articulo.preventa.toLocaleString()}</td>
            <td>${articulo.stockactual}</td>
        `;
                cuerpo.appendChild(fila);
            });
        }

        function abrirModalInforme() {
            const modal = new bootstrap.Modal(document.getElementById('modalInforme'));
            modal.show();
            mostrarInformeVentas(ventas);  // ventas es tu arreglo con todas las ventas
        }
        function mostrarInformeVentas(listaVentas) {
            const cuerpo = document.getElementById("cuerpoInformeVentas");
            cuerpo.innerHTML = ""; // limpiar tabla

            if (listaVentas.length === 0) {
                cuerpo.innerHTML = `<tr><td colspan="7" class="text-center">No hay ventas para mostrar.</td></tr>`;
                return;
            }

            listaVentas.forEach(v => {
                const fechaObj = new Date(v.fecha);
                const fechaStr = fechaObj.toLocaleDateString() + " " + fechaObj.toLocaleTimeString();

                const condicion = v.condicion || "contado"; // toma "contado" si no existe

                const estado = v.anulada ? "Anulada" : "Exitosa";

                cuerpo.innerHTML += `
            <tr>
                <td>${v.factura}</td>
                <td>${fechaStr}</td>
                <td>${v.cliente}</td>
                <td>${v.total.toFixed(2)}</td>
                <td>${v.iva.toFixed(2)}</td>
                <td>${condicion.charAt(0).toUpperCase() + condicion.slice(1)}</td>
                <td>${estado}</td>
            </tr>
        `;
            });
        }
        function aplicarFiltrosInforme() {
            const desde = document.getElementById("filtroDesde").value;
            const hasta = document.getElementById("filtroHasta").value;
            const condicion = document.getElementById("filtroCondicion").value;
            const estado = document.getElementById("filtroEstado").value;

            let filtradas = ventas;

            if (desde) {
                const desdeDate = new Date(desde);
                filtradas = filtradas.filter(v => new Date(v.fecha) >= desdeDate);
            }
            if (hasta) {
                const hastaDate = new Date(hasta);
                hastaDate.setHours(23, 59, 59, 999);
                filtradas = filtradas.filter(v => new Date(v.fecha) <= hastaDate);
            }
            if (condicion) {
                filtradas = filtradas.filter(v => ((v.condicion || "contado").toLowerCase()) === condicion.toLowerCase());
            }

            if (estado) {
                if (estado === "exitosa") {
                    filtradas = filtradas.filter(v => !v.anulada);
                } else if (estado === "anulada") {
                    filtradas = filtradas.filter(v => v.anulada);
                }
            }

            mostrarInformeVentas(filtradas);
        }
        function resetearFiltrosInforme() {
            document.getElementById("formFiltrosInforme").reset();
            mostrarInformeVentas(ventas);
        }
        function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const logoBase64 = 'data:image/jpeg;base64,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EDzg4mizkjOeo4J6np1Br0O51bw54Y0yTQJITJC8UbYBJ+0BzhmyOhA57dOKKt9Fuwj1OI1SwsU8awwW92/2S8COZYSRtLgZYD0B5288cVFqkMmiatDMl/PqKQtuRpo5Y+R9ew68Gn31mmha/dPot0zJYNsN1cAHy2PG1R3I5GQOxIAAzWv4bjuPF8rW0viy/jnxuMDKRvHfHzYOPoPpWjdkm3pb+ugt3Y2ptc1TxrpMEnh/UEsru3OZrfJRpHwSNrdxwflOO+exrEn+I/iLS47nTdUtYvtiqV8x02sjf3sdCO44x05Iqn4q8Maj4T1ZbnTmumtGT5bhSSykjDAkdCefwP1rb8PWmp+MvEFnqOsWii0s42UyvDt8/OcDHcc/TA9TzlaEVzaNfiVdt26nGWPiDUnNzBJfXUi3UTRupJfdkcYB7k9/r2rb+HniODwtq15a6tvt458KzMhOx1zwR1HUjvz6Cu9vPhroF1J5scEtq+c5t5Cv884/CpH+HuhzQKl1DLcyL1nllJkb6kdaUsRTlFq24KDTucT43ksv+Emtda0W9tb64lZA1sP3mWAwOB2IwMcH+jtM/wCErbw+NAsdFltkm3Ca5mQrncecZ4HHHf8AOvQtL8H6Jo0wmsbCNJR0kYlyPpnp+FblYuukkkr27lKDvdnM+GvBtloWn2iTRpNeQkyGU9nYAHHtwB+GetdNRRWDk5O7LSSCiiikMKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigArzn4j6FfzapaaxaWv2yKFPKlg2lsjJPT0IOMjp9a9GoqoTcHdCaurHidrYvr1mujaHoc9pHJcLJcXM8hcLgEAE7eAMk9z+NN8Z6Pdp4ygslRF+0LFFbAtnCLhFye2Sufxr22uP8AFHh+41Hxl4fvreMtHBITM2OFCkMM/XkV0U6/vXM3DQ4i6sbjw59ut/EGky3NnqOyUywEZikGeh5GQWI7ce3FXPA2kXF/4pt9SsrGSy0u0UqrSHl+COv8RJJJxwPYYFetUtS8Q2npqx8lmLRRRXOaBRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAf/9k'; // tu cadena base64    

            const fechaActual = new Date();
            const fechaTexto = fechaActual.toLocaleDateString();
            const horaTexto = fechaActual.toLocaleTimeString();

            // Título + Fecha/Hora
            const titulo = "Informe de Ventas";
            const subTitulo = `Emitido el ${fechaTexto} a las ${horaTexto}`;

            // Membrete
            const empresa = "Casa Yasy S.A";
            const direccion = "Av. Pinedo";
            const telefono = "Tel: 2222222";
            const anchoImagen = 40;
            const altoImagen = 15;
            const centroX = (doc.internal.pageSize.getWidth() - anchoImagen) / 2;

            // Insertar logo centrado arriba
    doc.addImage(logoBase64, 'PNG', centroX, 10, anchoImagen, altoImagen);

            // Encabezado
            doc.setFontSize(14);
            doc.text(empresa, 14, 10);
            doc.setFontSize(10);
            doc.text(direccion, 14, 15);
            doc.text(telefono, 14, 20);

            // Título
            doc.setFontSize(12);
            doc.text(titulo, 105, 30, { align: 'center' });
            doc.setFontSize(9);
            doc.text(subTitulo, 105, 35, { align: 'center' });

            // Filtros (si hay)
            let filtroTexto = "";
            const desde = document.getElementById("filtroDesde").value;
            const hasta = document.getElementById("filtroHasta").value;
            const condicion = document.getElementById("filtroCondicion").value;
            const estado = document.getElementById("filtroEstado").value;

            if (desde || hasta || condicion || estado) {
                filtroTexto += "Filtros aplicados: ";
                if (desde) filtroTexto += `Desde: ${desde} `;
                if (hasta) filtroTexto += `Hasta: ${hasta} `;
                if (condicion) filtroTexto += `Condición: ${condicion} `;
                if (estado) filtroTexto += `Estado: ${estado}`;
            }

            if (filtroTexto) {
                doc.setFontSize(9);
                doc.text(filtroTexto.trim(), 14, 43);
            }

            // Tabla
            const tabla = document.getElementById("tablaInformeVentas");
            const headers = [];
            const rows = [];

            tabla.querySelectorAll("thead tr th").forEach(th => headers.push(th.textContent.trim()));
            tabla.querySelectorAll("tbody tr").forEach(tr => {
                const row = [];
                tr.querySelectorAll("td").forEach(td => row.push(td.textContent.trim()));
                rows.push(row);
            });

            doc.autoTable({
                head: [headers],
                body: rows,
                startY: filtroTexto ? 48 : 43,
                margin: { top: 10 },
                styles: { fontSize: 8 },
                didDrawPage: function (data) {
                    // Número de página
                    const pageCount = doc.internal.getNumberOfPages();
                    const pageSize = doc.internal.pageSize;
                    const pageHeight = pageSize.height ? pageSize.height : pageSize.getHeight();
                    const pageNumber = doc.internal.getCurrentPageInfo().pageNumber;

                    doc.setFontSize(8);
                    doc.text(`Página ${pageNumber} de ${pageCount}`, data.settings.margin.left, pageHeight - 5);
                }
            });

            doc.save("informe_ventas.pdf");
        }
        function imprimirFactura(venta) {
            const div = document.getElementById("contenidoFactura");

            const fecha = new Date(venta.fecha).toLocaleString();
            const usuario = venta.usuario || "Caja 1";  // ajusta según tu lógica
            const caja = venta.caja || "1";

            let html = `
        <div style="text-align: center;">
            <h3>Casa Yasy S.A</h3>
            <p>RUC: 12345678-9</p>
            <p>Av. Pinedo</p>
            <p>Tel: (222) 456-789</p>
            <hr>
        </div>

        <p><strong>Factura N°:</strong> ${venta.factura}</p>
        <p><strong>Fecha:</strong> ${fecha}</p>
        <p><strong>Caja:</strong> ${caja}</p>
        <p><strong>Atendió:</strong> ${usuario}</p>
        <p><strong>Cliente:</strong> ${venta.cliente}</p>
        <p><strong>RUC:</strong> ${venta.ruc}</p>
        <hr>

        <table style="width:100%; font-size: 12px;">
            <thead>
                <tr>
                    <th>Desc</th>
                    <th>Cant</th>
                    <th>Precio</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
    `;

            venta.detalle.forEach(item => {
                html += `
            <tr>
                <td>${item.descripcion}</td>
                <td>${item.cantidad}</td>
                <td>${item.precio.toFixed(0)}</td>
                <td>${(item.precio * item.cantidad).toFixed(0)}</td>
            </tr>
        `;
            });

            html += `
    </tbody>
</table>
<hr>
<p><strong>IVA:</strong> ${venta.iva.toLocaleString("es-ES")}</p>
<p><strong>Total:</strong> ${venta.total.toLocaleString("es-ES")}</p>
<p><strong>Pago:</strong> ${venta.pago.toLocaleString("es-ES")}</p>
<p><strong>Vuelto:</strong> ${venta.vuelto.toLocaleString("es-ES")}</p>
<hr>
<p style="text-align: center;">¡Gracias por su compra!</p>
`;

            div.innerHTML = html;

            const areaImprimir = document.getElementById("facturaImprimir").innerHTML;

            const ventana = window.open('', 'PRINT', 'height=600,width=400');
            ventana.document.write('<html><head><title>Factura</title>');
            ventana.document.write('</head><body>');
            ventana.document.write(areaImprimir);
            ventana.document.write('</body></html>');
            ventana.document.close();
            ventana.focus();
            ventana.print();
            ventana.close();
        }

    </script>
    <script src="js/bdP.js"></script> <!-- archivo con el arreglo ventas -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jsPDF y autoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <!-- SheetJS (xlsx) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <div id="facturaImprimir" style="display: none; font-family: monospace; width: 80mm; padding: 10px;">
        <div id="contenidoFactura"></div>
    </div>

</body>

</html>